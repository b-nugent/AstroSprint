<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 1</title>
	<script type="text/javascript" src="js/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
// Full Docs: http://docs.phaser.io
// Phase.Game() Docs: http://docs.phaser.io/Phaser.Game.html
    
"use strict";

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
var platforms = undefined;
var player = undefined;
var planet1 = undefined;
var planet2 = undefined;
var cursors = undefined;
var star = undefined;
var score = 0;
var scoreText = undefined;
var targetPlanet = undefined;
var offGround = false;

function preload() {
	game.load.image('sky', 'assets/sky.png');
	game.load.image('star', 'assets/star.png');
	game.load.image('diamond', 'assets/diamond.png');
    game.load.image('planet', 'assets/circle.png');
	game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
}

function create() {
	//start the physics system
	game.physics.startSystem(Phaser.Physics.P2JS);
    // Arcade needs to be active for stars to work.
    //game.physics.startSystem(Phaser.Physics.ARCADE);
    
    scoreText = game.add.text(16, 16, 'Score: 0', { fontSize: '24px', fill: '#F0F' });

    
    
    //add simple planet
    planet1 = game.add.sprite(game.world.width/2, game.world.height/2, 'planet');
	planet2 = game.add.sprite(600, 150, 'planet');
	//player
    //player = game.add.sprite(planet.x, planet.y - (planet.width / 2 + 9), 'dude');
    player = game.add.sprite(planet1.x + 20, planet1.y + (planet1.width / 2 + 9), 'dude');
	//var player = new Astronaut(planet.x + 20, planet.y + (planet.width / 2 + 9), planet1);
    
    star = game.add.sprite(500, 250, 'star');
    
    
	
    // Arcade needs to be active for stars to work.
    //game.physics.arcade.enable(player);
	game.physics.p2.enable([player, star], false);
	//planet 
	
	game.physics.p2.enable(planet1, false);
	
	planet1.body.static = true;
	planet1.anchor.setTo(0.5, 0.5);  
	planet1.body.setCircle(92);

	targetPlanet = planet1;
	
	game.physics.p2.enable(planet2, false);
	
	planet2.body.static = true;
	planet2.anchor.setTo(0.5, 0.5); 
	planet2.body.setCircle(92);
	
	
    //player physics properties
    player.body.collideWorldBounds = true;
    player.body.velocity.x = 1;
    player.anchor.setTo(0.5, 0.5);
    
    //star
    //star.body.static = true;
    
    //two animations for walking left and right
    player.animations.add('left', [0,1,2,3], 10, true);
    player.grounded = false;
    
    cursors = game.input.keyboard.createCursorKeys();
    
    
    
    //stars = game.add.group();
    //stars.enableBody = true;
    //var star = stars.create(275, 250, 'star');
    //star.body.gravity.y = 6;
    
    
    player.body.onBeginContact.add(playerContact, this);
    player.body.onEndContact.add(playerEndContact, this);
}

function update() {
    playerForceReset(player);
    
    //calculate the angle between the player and the planet
    var angle = Math.atan2(targetPlanet.y - player.y, targetPlanet.x - player.x);
    player.body.rotation = angle + game.math.degToRad(90) * -1;

    if(player.grounded)
    {
        //move player
        var playerSpeed = 300;
        playerMove(player, angle, playerSpeed);

        //allow player jump if they are touching the ground
        if(cursors.up.isDown)
        {
            var jumpStrength = 10000;
            playerJump(player, angle, jumpStrength);
			offGround = true;
        }
    }
    
    
    //calculate gravity
    var strength = 500;
    
    applyGravity(player, angle, strength);
    
    //allow the player to fall if not grounded
    if(cursors.down.isDown && !player.grounded)
    {
       // console.log(player.grounded);
		var jumpStrength = 5000;
        playerFall(player, angle, jumpStrength);
    }
    
    player.body.angularVelocity = clampSpeed(player);
    
    // Star collision
    //game.physics.arcade.collide(stars);
    //game.physics.arcade.overlap(player, stars, collectStar, null, this);
    
    //check for players overlapping with stars
    /*
    game.physics.arcade.overlap(player, stars, collectStar, null, this);
    game.physics.arcade.overlap(player, diamonds, collectDiamond, null, this);
    */
}
    
    //be attracted toward the center of the planet
    function applyGravity(player, angle, strength)
    {
        player.body.force.x += Math.cos(angle) * strength;
        player.body.force.y += Math.sin(angle) * strength;
		//should we be attracted to a new planet)
		if(offGround){
			if(targetPlanet === planet1){
				if(game.physics.arcade.distanceBetween(planet2,player) < 125){
					targetPlanet = planet2;
					offGround = false;
				}
			}
			else{
				if(game.physics.arcade.distanceBetween(planet1,player) < 125){
					targetPlanet = planet1;
					offGround = false;
				}
			}
		}
    }
    
    //move the player
    function playerMove(player, angle, speed)
    {
        player.animations.play('left');
        player.body.force.x += Math.cos(angle + 90) * speed;
        player.body.force.y += Math.sin(angle + 90) * speed;

    }
    
    //player jump
    function playerJump(player, angle, speed) {
		if (angle > 0){
            if(angle > game.math.degToRad(90)) {
                // Quadrant II, sin is positive
                player.body.force.x += Math.abs(Math.cos(angle) * speed);
                player.body.force.y += Math.abs(Math.sin(angle) * speed) * -1;
            } else {
                // Quadrant I, both are positve
                player.body.force.x += Math.abs(Math.cos(angle * -1) * speed) * -1;
                player.body.force.y += Math.abs(Math.sin(angle * -1) * speed) * -1;
            }
		} else {
            if (angle > game.math.degToRad(-90)) {
                // Quadrant III, neither are positive
                player.body.force.x += Math.abs(Math.cos(angle) * speed) * -1;
                player.body.force.y += Math.abs(Math.sin(angle) * speed);
            } else {
                // Quadrant IV, cos is positive
                player.body.force.x += Math.abs(Math.cos(angle * -1) * speed);
                player.body.force.y += Math.abs(Math.sin(angle * -1) * speed);
            }
		}
    }
    
    function playerFall(player, angle, speed) {
        
        player.body.force.x += Math.cos(angle) * speed;
        player.body.force.y += Math.sin(angle) * speed;
    }
    
    //reset the forces on the player to 0
    function playerForceReset(player) {
        player.body.force.x = 0;
        player.body.force.y = 0;
    }
    
    /*function grounded(player, planet, angle)
    {
        var grounded = false;
        var groundPoint = new Phaser.Point(player.body.x + (Math.cos(angle) * (player.body.width + 1)), player.body.y + (Math.sin(angle)* (player.body.height + 1)));
        
        var graphics = game.add.graphics(0,0);
    
        graphics.beginFill(0xFFCC00, 1);
        graphics.drawCircle(groundPoint.x, groundPoint.y, 10);
        
        
        var touchedPlanets = game.physics.p2.hitTest(groundPoint, planet);
        
        if(touchedPlanets.length == 1)
        {
            grounded = true;
        }
        
        return grounded;
    }*/
    
    
    function playerContact(body, shapeA, shapeB, equation)
    {
        if(body != null)
        {
            switch(body.sprite.key){
                    case "planet":
                        setGrounded();
						offGround = false;
                        break;
                    case "star":
                        collectStar(body);
                        break;
            }
        }
    }
    function playerEndContact(body, shapeA, shapeB, equation)
    {
        if(body != null && body.sprite != null)
        {
            switch(body.sprite.key){
                    case "planet":
                        setGrounded();
                        break;
            }
        }
    }
    
    function collectStar(star)
    {
        //removes the star from the screen
        //star.alive = false;
        star.sprite.exists = false;
        star.destroy();
        
        score += 10;
        scoreText.text = 'Score: ' + score;
    }
    
    function setGrounded()
    {
        player.grounded = !player.grounded;
    }
    
    function getMag(x, y) {
        //var vector = new Phaser.Point(x, y);
        //var magnitude = vector.getMagnitude();
        var magnitude = Math.sqrt((x * x) + (y * y));
        return magnitude;
    }
    
    function normalizeVector(vector) {
        var normalizedX = vector.x / getMag(vector.x, vector.y);
        var normalizedY = vector.x / getMag(vector.x, vector.y);
        var normalizedVector = new Phaser.Vector(normalizedX, normalizedY);
        return normalizedVector;
    }
    
    
    function clampSpeed(player) {
        //var body = player.body;
        var currentSpeed = getMag(player.body.angularVelocity.x, player.body.angularVelocity.y);
        //var currentSpeed = player.body.angularVelocity;
        //console.log("X: " + player.body.velocity.x + " Y: " + player.body.velocity.y);
        //var currentSpeed = player.body.velocity.getMagnitude();
        //console.log("CurrentSpeed: " + currentSpeed);
        //console.log(player.body.angularVelocity);
        var maxSpeed = -5;
        var minSpeed = 0.5;
        if(currentSpeed < maxSpeed || currentSpeed > minSpeed) {
            //debugger;
            // Issue here when you make a point from the angular velocity (it becomes a 0,0 point.
            //var point = new Phaser.Point(player.body.angularVelocity.x, player.body.angularVelocity.y);
            //var newVector = point.normalize();
            //newVector *= maxSpeed;
            //return newVector;
            var newSpeed = normalizeVector(player.body.angularVelocity) * maxSpeed;
            return newSpeed;
        } else {
            return player.body.angularVelocity;
        }
        /*
        if (currentSpeed < 0) {
            currentSpeed = 0;
            return currentSpeed;
        }
        
        return currentSpeed;
        */
        
        
    }

</script>

</body>
</html>